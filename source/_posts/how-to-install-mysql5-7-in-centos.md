title: How to install mysql5.7 in centos
date: 2017-08-14 21:32:06
categories: programming
tags:
- mysql
- linux
- centos
- aliyun
---

# 安装说明：

本文介绍的Mysql安装的适用环境为：

* OS：RHEL/CentOS 7/6
* Mysql：5.7 major version
* 安装方式：全新安装，非全新安装的情况下请做好数据备份。

<!--more-->

# 源代码安装 or RPM包安装？
---

两种安装方式笔者都有尝试过，建议在非特殊情况下使用rpm包进行安装，原因是由于源代码安装的方式过于耗时。笔者之前在一台阿里云ECS上使用源代码的方式安装（4 core，16GB memory，普通云盘），整个make过程大概耗时30分钟，期间这台机器的CPU使用率一直100%，整体load相当高。

若确实有源码安装的需要，请参考[这篇文章](http://www.jianshu.com/p/95a103add722)。

# 安装Mysql
---

## Step 1: 添加Mysql yum镜像源

rpm包文件的规则为：**platform-and-version-specific-package-name**

例如：

```
# mysql57-community: 以5.7为主版本的社区版
# el6: RED Hat 6 or CentOS6
# {version-number}: 次版本号.
mysql57-community-release-el6-{version-number}.noarch.rpm
```

**Download rpm package:**

* RHEL/CentOS 7:

```
cd /usr/local/src/

wget http://dev.mysql.com/get/mysql57-community-release-el7-11.noarch.rpm
```

* RHEL/CentOS 6:

```
cd /usr/local/src/

wget http://dev.mysql.com/get/mysql57-community-release-el6-11.noarch.rpm
```

**Install rpm package:**

* RHEL/CentOS 7:

```
cd /usr/local/src/

yum localinstall mysql57-community-release-el7-11.noarch.rpm
```

* RHEL/CentOS 6:

```
cd /usr/local/src/

yum localinstall mysql57-community-release-el6-11.noarch.rpm
```

**验证rpm包是否安装成功：**

```
yum repolist enabled | grep "mysql.*-community.*"

# output

Repodata is over 2 weeks old. Install yum-cron? Or run: yum makecache fast
!mysql-connectors-community/x86_64 MySQL Connectors Community                 39
!mysql-tools-community/x86_64      MySQL Tools Community                      47
!mysql57-community/x86_64          MySQL 5.7 Community Server                207
```

## Step 2: 安装Mysql的最新版本

执行下面的命令将一键安装Mysql5.7的4个组件，分别为：mysql-community-server, mysql-community-client, mysql-community-common,  mysql-community-libs。

```
yum install mysql-community-server
```

如果你想安装其它版本，例如Mysql5.6，可以执行如下的命令：

```
yum-config-manager --disable mysql57-community
yum-config-manager --enable mysql56-community
```

# 配置/etc/my.cnf
---

* 生产环境下，强烈建议将datadir，log-bin设置到单独的数据目录下。这么做的好处是：

	1. 所有的数据文件和bin-log统一存放在一个目录下，便于恢复和管理。

	2. 设置单独的比较大的磁盘分区来挂载目录。 

* 阿里云环境下，若是有未挂载的磁盘，强烈建议使用[这个教程的脚本](https://help.aliyun.com/knowledge_detail/42526.html?spm=5176.100241.0.0.dhww23)。

## 创建Mysql数据文件和Bin-log目录：

假设根目录为: /alidata1/，创建的规则为：/alidata1/mysql/{port}/data/mybinlog

```
mkdir -p /alidata1/mysql/3306/data/mybinlog
```

> 由于上述目录创建的时候，可能使用的是非mysql用户账号，因此需要更改目录和用户组权限。

```
chown -R mysql:mysql /alidata1/mysql/
```

## 调整/etc/my.cnf的重要参数

### 备份my.cnf：

```
cp /etc/my.cnf /etc/my.cnf.bak
```

### 支持utf8mb4（emoji表情）：

```
[client]
default-character-set = utf8mb4

[mysqld]
character-set-server = utf8mb4
collation-server = utf8mb4_general_ci
init-connect='SET NAMES utf8mb4' # 重要，确保utf8mb4生效
```

### 设置默认时区：

设置为与application server设置为一致的时区，以避免程序显示时日期类型时，出现时区不一致导致的日期错误问题。

```
[mysqld]
default-time_zone = '+8:00'
```

### 修改默认的datadir、bin-log目录、slowlog目录、errorlog目录：

```
[client]
port	= 3306
socket	= /dev/shm/mysql.sock

[mysqld]
user    = mysql
port    = 3306
datadir	= /alidata1/mysql/3306/data/
socket  = /dev/shm/mysql.sock
pid-file = /alidata1/mysql/3306/data/mysql.pid
slow_query_log = 1
slow_query_log_file = /alidata1/mysql/3306/data/slow.log
log-error = /alidata1/mysql/3306/data/error.log
long_query_time = 0.1
log-bin = /alidata1/mysql/3306/data/mybinlog
```

PS：关于/dev/shm/目录，更多内容请参考：

* http://www.361way.com/dev-shm/4029.html
* https://www.cyberciti.biz/tips/what-is-devshm-and-its-practical-usage.html

### 完整的配置：

NOTE: 以下的配置是参考了http://imysql.com/my-cnf-wizard.html，可以根据实际的情况进行调整。

```
#
## optimized mysql configure file my.cnf
## generated by yejr(imysql@imysql.com, http://imysql.com, QQ: 4700963)
## 叶金荣(yejr)
## 叶金荣(yejr)，最有良心、最有品质的在线培训品牌知数堂培训(http://zhishuedu.com)联合创始人
## 新浪微博: @叶金荣, 微信公众：老叶茶馆
## QQ群:579036588、529671799
## 注意：个别建议可能需要根据实际情况作调整，请自行判断或联系我，本人不对这些建议结果负相应责任
## 本配置文件主要适用于MySQL 5.7版本
#
[client]
port	= 3306
socket	= /dev/shm/mysql.sock
default-character-set = utf8mb4

[mysql]
prompt="\u@mysqldb \R:\m:\s [\d]> "
no-auto-rehash

[mysqld]
character-set-server = utf8mb4
collation-server = utf8mb4_general_ci
init-connect='SET NAMES utf8mb4'
default-time_zone = '+8:00'
user	= mysql
port	= 3306
datadir	= /alidata1/mysql/3306/data/
socket	= /dev/shm/mysql.sock
pid-file = mysqldb.pid
character-set-server = utf8mb4
skip_name_resolve = 1
open_files_limit    = 65535
back_log = 1024
max_connections = 512
max_connect_errors = 1000000
table_open_cache = 1024
table_definition_cache = 1024
table_open_cache_instances = 64
thread_stack = 512K
external-locking = FALSE
max_allowed_packet = 32M
sort_buffer_size = 4M
join_buffer_size = 4M
thread_cache_size = 768
query_cache_size = 0
query_cache_type = 0
interactive_timeout = 600
wait_timeout = 600
tmp_table_size = 32M
max_heap_table_size = 32M
slow_query_log = 1
slow_query_log_file = /alidata1/mysql/3306/data/slow.log
log-error = /alidata1/mysql/3306/data/error.log
long_query_time = 0.1
log_queries_not_using_indexes =1
log_throttle_queries_not_using_indexes = 60
min_examined_row_limit = 100
log_slow_admin_statements = 1
log_slow_slave_statements = 1
server-id = 3306
log-bin = /alidata1/mysql/3306/data/mybinlog
sync_binlog = 1
binlog_cache_size = 4M
max_binlog_cache_size = 2G
max_binlog_size = 1G
expire_logs_days = 7
master_info_repository = TABLE
relay_log_info_repository = TABLE
gtid_mode = on
enforce_gtid_consistency = 1
log_slave_updates
binlog_format = row
relay_log_recovery = 1
relay-log-purge = 1
key_buffer_size = 32M
read_buffer_size = 8M
read_rnd_buffer_size = 4M
bulk_insert_buffer_size = 64M
myisam_sort_buffer_size = 128M
myisam_max_sort_file_size = 10G
myisam_repair_threads = 1
lock_wait_timeout = 3600
explicit_defaults_for_timestamp = 1
innodb_thread_concurrency = 0
innodb_sync_spin_loops = 100
innodb_spin_wait_delay = 30

transaction_isolation = REPEATABLE-READ
#innodb_additional_mem_pool_size = 16M
innodb_buffer_pool_size = 22938M
innodb_buffer_pool_instances = 8
innodb_buffer_pool_load_at_startup = 1
innodb_buffer_pool_dump_at_shutdown = 1
innodb_data_file_path = ibdata1:1G:autoextend
innodb_flush_log_at_trx_commit = 1
innodb_log_buffer_size = 32M
innodb_log_file_size = 2G
innodb_log_files_in_group = 2
innodb_max_undo_log_size = 4G

# 根据您的服务器IOPS能力适当调整
# 一般配普通SSD盘的话，可以调整到 10000 - 20000
# 配置高端PCIe SSD卡的话，则可以调整的更高，比如 50000 - 80000
innodb_io_capacity = 4000
innodb_io_capacity_max = 8000
innodb_flush_neighbors = 0
innodb_write_io_threads = 8
innodb_read_io_threads = 8
innodb_purge_threads = 4
innodb_page_cleaners = 4
innodb_open_files = 65535
innodb_max_dirty_pages_pct = 50
innodb_flush_method = O_DIRECT
innodb_lru_scan_depth = 4000
innodb_checksum_algorithm = crc32
#innodb_file_format = Barracuda
#innodb_file_format_max = Barracuda
innodb_lock_wait_timeout = 10
innodb_rollback_on_timeout = 1
innodb_print_all_deadlocks = 1
innodb_file_per_table = 1
innodb_online_alter_log_max_size = 4G
internal_tmp_disk_storage_engine = InnoDB
innodb_stats_on_metadata = 0

innodb_status_file = 1
# 注意: 开启 innodb_status_output & innodb_status_output_locks 后, 可能会导致log-error文件增长较快
innodb_status_output = 0
innodb_status_output_locks = 0

#performance_schema
performance_schema = 1
performance_schema_instrument = '%=on'

#innodb monitor
innodb_monitor_enable="module_innodb"
innodb_monitor_enable="module_server"
innodb_monitor_enable="module_dml"
innodb_monitor_enable="module_ddl"
innodb_monitor_enable="module_trx"
innodb_monitor_enable="module_os"
innodb_monitor_enable="module_purge"
innodb_monitor_enable="module_log"
innodb_monitor_enable="module_lock"
innodb_monitor_enable="module_buffer"
innodb_monitor_enable="module_index"
innodb_monitor_enable="module_ibuf_system"
innodb_monitor_enable="module_buffer_page"
innodb_monitor_enable="module_adaptive_hash"

[mysqldump]
quick
max_allowed_packet = 32M
```

### 更多关于Mysql的调优：

TODO：

* http://www.speedemy.com/17-key-mysql-config-file-settings-mysql-5-7-proof/

* http://www.speedemy.com/mysql-5-7-default-configuration-whats-new-and-whats-not/

* http://www.speedemy.com/mysql/17-key-mysql-config-file-settings/innodb_buffer_pool_size/

# 启动Mysql
---

```
service mysqld start

or

systemctl start mysqld.service
```

验证Mysql是否启动成功：

```
systemctl status mysqld.service

● mysqld.service - MySQL Server
   Loaded: loaded (/usr/lib/systemd/system/mysqld.service; enabled; vendor preset: disabled)
   Active: active (running) since Mon 2017-08-14 16:03:47 CST; 7h ago
     Docs: man:mysqld(8)
           http://dev.mysql.com/doc/refman/en/using-systemd.html
 Main PID: 933 (mysqld)
   CGroup: /system.slice/mysqld.service
           └─933 /usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid

Aug 14 16:03:45 testdb systemd[1]: Starting MySQL Server...
Aug 14 16:03:47 testdb systemd[1]: Started MySQL Server.
```

查看Mysql的版本：

```
mysql --version

mysql  Ver 14.14 Distrib 5.7.19, for Linux (x86_64) using  EditLine wrapper
```

如果启动时未能成功，可以查看mysql的错误日志，根据错误提示调整my.cnf配置文件。

```
tail -n 20 /alidata1/mysql/3306/data/error.log
```

# 对Mysql进行基本的安全配置
---

我们可以使用mysql_secure_installation命令来进行一些比较重要的基本安全配置，包括：设置root账号密码，删除匿名用户，不允许root账号远程登录等。

执行mysql_secure_installation命令

```
mysql_secure_installation
```

根据提示一步步地进行设置：

```
Securing the MySQL server deployment.
Enter password for user root: Enter New Root Password
VALIDATE PASSWORD PLUGIN can be used to test passwords
and improve security. It checks the strength of password
and allows the users to set only those passwords which are
secure enough. Would you like to setup VALIDATE PASSWORD plugin?
Press y|Y for Yes, any other key for No: y
There are three levels of password validation policy:
LOW    Length >= 8
MEDIUM Length >= 8, numeric, mixed case, and special characters
STRONG Length >= 8, numeric, mixed case, special characters and dictionary                  file
Please enter 0 = LOW, 1 = MEDIUM and 2 = STRONG: 2
Using existing password for root.
Estimated strength of the password: 50 
Change the password for root ? ((Press y|Y for Yes, any other key for No) : y
New password: Set New MySQL Password
Re-enter new password: Re-enter New MySQL Password
Estimated strength of the password: 100 
Do you wish to continue with the password provided?(Press y|Y for Yes, any other key for No) : y
By default, a MySQL installation has an anonymous user,
allowing anyone to log into MySQL without having to have
a user account created for them. This is intended only for
testing, and to make the installation go a bit smoother.
You should remove them before moving into a production
environment.
Remove anonymous users? (Press y|Y for Yes, any other key for No) : y
Success.
Normally, root should only be allowed to connect from
'localhost'. This ensures that someone cannot guess at
the root password from the network.
Disallow root login remotely? (Press y|Y for Yes, any other key for No) : y
Success.
By default, MySQL comes with a database named 'test' that
anyone can access. This is also intended only for testing,
and should be removed before moving into a production
environment.
Remove test database and access to it? (Press y|Y for Yes, any other key for No) : y
- Dropping test database...
Success.
- Removing privileges on test database...
Success.
Reloading the privilege tables will ensure that all changes
made so far will take effect immediately.
Reload privilege tables now? (Press y|Y for Yes, any other key for No) : y
Success.
All done! 
```

# 使用root账号连接Mysql并设置账号，分配权限
---

```
mysql -u root -p
```

```
CREATE USER '<db_account>'@'%' IDENTIFIED BY '<password>';

GRANT ALL PRIVILEGES ON *.* TO '<db_account>'@'%' identified by '<password>’;

FLUSH PRIVILEGES;
```

NOTE：
* 生产环境下，建议不要使用%允许所有clinet连接。需要开通哪些client，就设置哪些client ip。
* 根据最小原则授权账号的权限。

例如：

```
GRANT ALL PRIVILEGES ON <db_name>.* TO '<db_account>'@'<client_ip>' identified by '<password>’;
```

